<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Lation‑Cup: Marlboro Hunt 2.5D</title>
<style>
  html,body{margin:0;height:100%;background:#08130e;color:#e9ffee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;touch-action:none}
  #ui{position:fixed;inset:0;display:flex;flex-direction:column;gap:.6rem;align-items:center;padding:10px}
  .card{background:rgba(255,255,255,.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px 12px}
  #top{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  input,button,label{font-size:16px}
  input[type="text"],button{border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#e9ffee;padding:8px 10px}
  button{cursor:pointer}
  #wrap{position:relative;width:100%;max-width:540px;aspect-ratio:9/16;border-radius:16px;overflow:hidden}
  canvas{display:block;width:100%;height:100%;background:linear-gradient(#071f16,#0a2d1f)}
  #hud{font-variant-numeric:tabular-nums}
  #leader{width:100%;max-width:540px}
  /* Mini‑game */
  #mini{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.55);z-index:10;touch-action:none}
  #miniInner{display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);padding:14px 16px;border-radius:14px}
  #miniHeader{display:flex;gap:14px;align-items:center;justify-content:center}
  #puffCounter{font-weight:700;font-size:16px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2)}
  #miniClock{font-size:16px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2)}
  #smokeSprite{width:180px;height:180px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:96px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.2);overflow:hidden}
  #tapBtn{font-size:22px;padding:14px 22px;border-radius:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25)}
  #meter{width:260px;height:18px;border:1px solid rgba(255,255,255,.35);border-radius:12px;overflow:hidden;background:rgba(0,0,0,.25)}
  #bar{height:100%;width:0;background:linear-gradient(90deg,#18ff9b,#66ffd6)}
  #msg{font-size:13px;opacity:.9}
  /* Joystick */
  #stick{position:absolute;left:16px;bottom:16px;width:120px;height:120px;border-radius:60px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);z-index:5;touch-action:none}
  #knob{position:absolute;left:50%;top:50%;width:56px;height:56px;margin:-28px 0 0 -28px;border-radius:50%;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25)}
  /* Uploaders */
  #icons{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
  .iconUp{display:flex;flex-direction:column;align-items:center;gap:.25rem}
  .iconUp input{width:120px}
  .iconPrev{width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
  .hint{font-size:12px;opacity:.8}
  #err{position:fixed;right:8px;bottom:8px;max-width:70vw;font:12px/1.3 ui-monospace,Menlo,monospace;background:#280b0b;color:#ffdede;border:1px solid #ff8a80;border-radius:8px;padding:8px;display:none;z-index:999}
</style>
</head>
<body>
<div id="ui">
  <div id="top" class="card">
    <b>🧪 Lation‑Cup</b>
    <input id="name" placeholder="Your name" style="min-width:120px">
    <button id="join">Join</button>
    <button id="start">Start (180s)</button>
    <span id="hud">⏱ 180 • 🟥 0 • ⚡ 1.0x</span>
  </div>

  <div id="wrap" class="card">
    <canvas id="cv"></canvas>

    <!-- Mini‑game overlay -->
    <div id="mini">
      <div id="miniInner">
        <div id="miniHeader">
          <div id="puffCounter">Puffs: 0</div>
          <div id="miniClock">6s</div>
        </div>
        <div id="smokeSprite">🚬</div>
        <button id="tapBtn">SMOKE!</button>
        <div id="meter"><div id="bar"></div></div>
        <div id="msg">Tap fast — the bar drains!</div>
      </div>
    </div>

    <!-- Virtual joystick -->
    <div id="stick"><div id="knob"></div></div>
  </div>

  <!-- Custom icons + mini‑game frames + player photo -->
  <div class="card" id="icons">
    <div class="iconUp">
      <div class="iconPrev" id="prevMarl">🟥</div>
      <label>🟥 Marlboro<img id="imgMarl" style="display:none"></label>
      <input type="file" id="fileMarl" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevCup">🥤</div>
      <label>🥤 Cup<img id="imgCup" style="display:none"></label>
      <input type="file" id="fileCup" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevTank">🛢️</div>
      <label>🛢️ 25L<img id="imgTank" style="display:none"></label>
      <input type="file" id="fileTank" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevShee">🥫</div>
      <label>🥫 Sheeba<img id="imgShee" style="display:none"></label>
      <input type="file" id="fileShee" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevSmoke1">🚬</div>
      <label>Smoke Frame A<img id="imgSmoke1" style="display:none"></label>
      <input type="file" id="fileSmoke1" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevSmoke2">😮‍💨</div>
      <label>Smoke Frame B<img id="imgSmoke2" style="display:none"></label>
      <input type="file" id="fileSmoke2" accept="image/*">
    </div>
    <div class="iconUp">
      <div class="iconPrev" id="prevPlayer">🙂</div>
      <label>Player Photo<img id="imgPlayer" style="display:none"></label>
      <input type="file" id="filePlayer" accept="image/*">
    </div>

    <div class="hint">Upload 64×64 images (any size works; they’ll scale). Emojis are used if no image.</div>
  </div>

  <div id="leader" class="card"><b>Leaderboard</b><div id="lb"></div></div>
</div>

<div id="err"></div>

<!-- Firebase (optional multiplayer) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
/*** ====== MULTIPLAYER (optional) ====== */
const firebaseConfig = {
  // apiKey: "...",
  // authDomain: "...",
  // databaseURL: "...",
  // projectId: "...",
  // storageBucket: "...",
  // messagingSenderId: "...",
  // appId: "..."
};
let FB = {enabled:false, app:null, db:null, auth:null, uid:null};
try {
  if (firebaseConfig.apiKey) {
    FB.app = firebase.initializeApp(firebaseConfig);
    FB.db = firebase.database();
    FB.auth = firebase.auth();
    FB.enabled = true;
  }
} catch(e){ logErr("Firebase init failed: "+e); }

/* ================= Core Game ================= */
const CV = document.getElementById('cv');
const CTX = CV.getContext('2d');
const UI = {
  name: document.getElementById('name'),
  join: document.getElementById('join'),
  start: document.getElementById('start'),
  hud: document.getElementById('hud'),
  lb: document.getElementById('lb'),
  mini: document.getElementById('mini'),
  tapBtn: document.getElementById('tapBtn'),
  bar: document.getElementById('bar'),
  msg: document.getElementById('msg'),
  miniClock: document.getElementById('miniClock'),
  puffCounter: document.getElementById('puffCounter'),
  smokeSprite: document.getElementById('smokeSprite'),
  stick: document.getElementById('stick'),
  knob: document.getElementById('knob'),
  prevMarl: document.getElementById('prevMarl'),
  prevCup: document.getElementById('prevCup'),
  prevTank: document.getElementById('prevTank'),
  prevShee: document.getElementById('prevShee'),
  fileMarl: document.getElementById('fileMarl'),
  fileCup: document.getElementById('fileCup'),
  fileTank: document.getElementById('fileTank'),
  fileShee: document.getElementById('fileShee'),
  prevSmoke1: document.getElementById('prevSmoke1'),
  prevSmoke2: document.getElementById('prevSmoke2'),
  fileSmoke1: document.getElementById('fileSmoke1'),
  fileSmoke2: document.getElementById('fileSmoke2'),
  prevPlayer: document.getElementById('prevPlayer'),
  filePlayer: document.getElementById('filePlayer'),
};

UI.name.value = randomName();

// DPR‑aware canvas
function resizeCanvas(){
  const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  const rect = CV.getBoundingClientRect();
  CV.width  = Math.round(rect.width  * dpr);
  CV.height = Math.round(rect.height * dpr);
  CTX.setTransform(dpr,0,0,dpr,0,0);
}
new ResizeObserver(resizeCanvas).observe(CV);
resizeCanvas();

UI.join.onclick = async () => {
  if (!UI.name.value.trim()) return alert("Enter a name");
  if (FB.enabled) {
    try {
      await FB.auth.signInAnonymously();
      FB.uid = FB.auth.currentUser.uid;
      const pRef = FB.db.ref(`lationcup/rooms/default/players/${FB.uid}`);
      pRef.onDisconnect().remove();
      await pRef.set({name:UI.name.value.trim(), x:P.x, y:P.y, score:0, ts:Date.now(), color:P.color});
      subPlayers();
      subItems();
    } catch(e){
      logErr("Firebase sign‑in failed: "+e);
      alert("Firebase sign‑in failed; continuing single‑player.");
    }
  }
  UI.join.disabled = true;
};

UI.start.onclick = () => { resetGame(); G.state='play'; UI.start.disabled = true; setTimeout(()=>UI.start.disabled=false,800); };

/* ==== World ==== */
const WORLD = {w:2000,h:2000};
const G = {state:'idle', time:180, score:0, mult:1, speedBase:140, t:0}; // 3 min
const P = {x:WORLD.w/2, y:WORLD.h/2, r:16, color:randColor(), vx:0, vy:0, photo:null};
const CAM = {x:P.x, y:P.y};
const ITEMS = new Map();
const OTHERS = new Map();

/* ==== Types & icons ==== */
const TYPES = {
  MARLB: {emoji:'🟥', r:16, img:null},
  CUP:   {emoji:'🥤', r:14, img:null},
  TANK:  {emoji:'🛢️', r:18, img:null},
  SHEE:  {emoji:'🥫', r:15, img:null},
};
setupIconLoader(UI.fileMarl, UI.prevMarl, TYPES.MARLB);
setupIconLoader(UI.fileCup,  UI.prevCup,  TYPES.CUP);
setupIconLoader(UI.fileTank, UI.prevTank, TYPES.TANK);
setupIconLoader(UI.fileShee, UI.prevShee, TYPES.SHEE);

/* Mini‑game images */
const SMOKE = {img1:null, img2:null, hasImgs:false};
setupSmokeLoader(UI.fileSmoke1, UI.prevSmoke1, 'img1');
setupSmokeLoader(UI.fileSmoke2, UI.prevSmoke2, 'img2');

/* Player photo */
UI.filePlayer.addEventListener('change', function(){
  const f = this.files?.[0]; if (!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=>{ P.photo = img; UI.prevPlayer.textContent=''; UI.prevPlayer.style.backgroundImage=`url(${url})`; UI.prevPlayer.style.backgroundSize='cover'; };
  img.onerror = ()=>{ P.photo=null; UI.prevPlayer.style.backgroundImage=''; UI.prevPlayer.textContent='🙂'; };
  img.src = url;
});

function setupIconLoader(inputEl, prevEl, typeRef){
  inputEl.addEventListener('change', function(){
    const f = this.files?.[0]; if (!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{ typeRef.img = img; prevEl.textContent=''; prevEl.style.backgroundImage=`url(${url})`; prevEl.style.backgroundSize='cover'; };
    img.onerror = ()=>{ alert('Image failed to load; using emoji.'); typeRef.img=null; prevEl.style.backgroundImage=''; prevEl.textContent = typeRef.emoji; };
    img.src = url;
  });
}
function setupSmokeLoader(inputEl, prevEl, key){
  inputEl.addEventListener('change', function(){
    const f = this.files?.[0]; if (!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{ SMOKE[key]=img; prevEl.textContent=''; prevEl.style.backgroundImage=`url(${url})`; prevEl.style.backgroundSize='cover'; SMOKE.hasImgs=!!(SMOKE.img1&&SMOKE.img2); };
    img.onerror = ()=> alert('Image failed to load.');
    img.src = url;
  });
}

/* ==== Loop ==== */
let last = performance.now();
function loop(now){
  try {
    const dt = Math.min(0.033,(now-last)/1000); last = now;
    update(dt); draw();
  } catch(e){ logErr("Loop error: "+(e&&e.stack?e.stack:e)); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  G.t += dt;
  if (G.state==='play'){
    G.time = Math.max(0, G.time - dt);
    if (G.time<=0){ G.state='over'; pushPlayer(); }
  }
  UI.hud.textContent = `⏱ ${Math.ceil(G.time)} • 🟥 ${G.score} • ⚡ ${G.mult.toFixed(1)}x`;

  applyJoystick(dt);

  const spd = G.speedBase * G.mult;
  P.x = clamp(P.x + P.vx * spd * dt, 0, WORLD.w);
  P.y = clamp(P.y + P.vy * spd * dt, 0, WORLD.h);

  CAM.x += (P.x - CAM.x)*0.15;
  CAM.y += (P.y - CAM.y)*0.15;

  if ((G.state==='play' || G.state==='idle') && ITEMS.size<40 && Math.random()<0.03) spawnItem();

  if (G.state==='play' && !Mini.active){
    for (const it of ITEMS.values()){
      if (it.claimedBy) continue;
      const dx = it.x - P.x, dy = it.y - P.y;
      const rr = (getType(it).r + P.r)**2;
      if (dx*dx+dy*dy <= rr){ claimItem(it); break; }
    }
  }

  if (G.mult>1) G.mult = Math.max(1, G.mult - 0.15*dt);

  pushPlayer();
}

function draw(){
  const w = CV.clientWidth, h = CV.clientHeight;
  const grd = CTX.createLinearGradient(0,0,0,h);
  grd.addColorStop(0,'#072017'); grd.addColorStop(1,'#0a2d21');
  CTX.fillStyle = grd; CTX.fillRect(0,0,w,h);

  drawGrid();

  const list = Array.from(ITEMS.values()).filter(i=>!i.claimedBy).sort((a,b)=>a.y-b.y);
  for (const it of list) drawItem(it);

  for (const g of OTHERS.values()){
    if (Date.now()-g.ts>4000) continue;
    drawDisc(g.x,g.y, 14, (g.color||'#fff')+'88');
  }

  drawPlayer(P.x,P.y,16,P.color,P.photo);

  CTX.fillStyle='rgba(255,255,255,.95)'; CTX.font='700 18px system-ui';
  CTX.textAlign='left'; CTX.textBaseline='top';
  CTX.fillText(`🟥 ${G.score}`, 10, 8);

  if (G.state==='idle') centerText("Press Start", 120, 24);
  else if (G.state==='over') centerText(`Finished! Score: ${G.score}`, 120, 20);
}

function drawGrid(){
  CTX.strokeStyle = 'rgba(255,255,255,.06)'; CTX.lineWidth = 1;
  const step = 80;
  const left = CAM.x - CV.clientWidth/2, top = CAM.y - CV.clientHeight/2;
  for (let y = Math.floor(top/step)*step; y<top+CV.clientHeight+step; y+=step){
    const yS = worldToScreenY(y); CTX.beginPath(); CTX.moveTo(0, yS); CTX.lineTo(CV.clientWidth, yS); CTX.stroke();
  }
  for (let x = Math.floor(left/step)*step; x<left+CV.clientWidth+step; x+=step){
    const xS = worldToScreenX(x); CTX.beginPath(); CTX.moveTo(xS, 0); CTX.lineTo(xS, CV.clientHeight); CTX.stroke();
  }
}

function centerText(t, y, size){ CTX.fillStyle='rgba(255,255,255,.9)'; CTX.font = `bold ${size}px system-ui`; CTX.textAlign='center'; CTX.fillText(t, CV.clientWidth/2, y); CTX.textAlign='left'; }

function drawDisc(wx,wy,r,col){
  const s = worldToScreen(wx,wy);
  CTX.fillStyle=col; CTX.beginPath(); CTX.arc(s.x,s.y, r*s.scale, 0, Math.PI*2); CTX.fill();
  CTX.fillStyle='rgba(0,0,0,.25)'; CTX.beginPath(); CTX.ellipse(s.x, s.y+3*s.scale, r*s.scale, r*s.scale*0.5, 0, 0, Math.PI*2); CTX.fill();
}
function drawPlayer(wx,wy,r,col,photo){
  const s = worldToScreen(wx,wy);
  const rad = r*s.scale;
  CTX.save();
  CTX.beginPath(); CTX.arc(s.x,s.y,rad,0,Math.PI*2); CTX.clip();
  if (photo){ CTX.drawImage(photo, s.x-rad, s.y-rad, rad*2, rad*2); }
  else { CTX.fillStyle=col; CTX.fillRect(s.x-rad, s.y-rad, rad*2, rad*2); }
  CTX.restore();
  // Shadow
  CTX.fillStyle='rgba(0,0,0,.25)'; CTX.beginPath(); CTX.ellipse(s.x, s.y+3*s.scale, rad, rad*0.5, 0, 0, Math.PI*2); CTX.fill();
}

function drawItem(it){
  const t = getType(it);
  const s = worldToScreen(it.x,it.y);
  if (t.img){
    const size = Math.round(t.r*2.4*s.scale);
    CTX.drawImage(t.img, s.x-size/2, s.y-size/2, size, size);
  } else {
    CTX.font = `${Math.round(t.r*2.2*s.scale)}px system-ui,Apple Color Emoji,Segoe UI Emoji`;
    CTX.textAlign='center'; CTX.textBaseline='middle';
    CTX.fillText(t.emoji, s.x, s.y);
  }
}

function worldToScreen(wx,wy){
  const x = (wx - CAM.x) + CV.clientWidth/2;
  const y = (wy - CAM.y) + CV.clientHeight/2;
  const scale = 0.9 + (y/CV.clientHeight)*0.2;
  return {x,y,scale};
}
function worldToScreenX(wx){ return (wx - CAM.x) + CV.clientWidth/2; }
function worldToScreenY(wy){ return (wy - CAM.y) + CV.clientHeight/2; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rand(min,max){ return Math.random()*(max-min)+min; }
function randColor(){ const h=Math.floor(Math.random()*360); return `hsl(${h} 85% 60%)`; }
function randomName(){ const a=['Green','Magic','Turbo','Cat','Neon','Marl','Slime','Ghost','Quick','Pixel']; const b=['Racer','Smoker','Runner','Wizard','Tank','Cup','Sheeba','Ninja','Hustle','Chaser']; return a[Math.floor(Math.random()*a.length)]+b[Math.floor(Math.random()*b.length)]; }
function getType(it){ return TYPES[it.type] || TYPES.MARLB; }

/* ===== Joystick / keys ===== */
let stickTouch=null, center=null, keyDir={x:0,y:0};
UI.stick.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.changedTouches[0]; stickTouch=t.identifier; center=centerOf(UI.stick); moveKnob(center.x,center.y); }, {passive:false});
UI.stick.addEventListener('touchmove',  e=>{ e.preventDefault(); const t=findTouch(e,stickTouch); if(!t)return; const dx=t.clientX-center.x, dy=t.clientY-center.y; const maxR=48, d=Math.hypot(dx,dy)||1; const nx=center.x+(d>maxR?dx/d*maxR:dx); const ny=center.y+(d>maxR?dy/d*maxR:dy); moveKnob(nx,ny); P.vx=(nx-center.x)/maxR; P.vy=(ny-center.y)/maxR; }, {passive:false});
UI.stick.addEventListener('touchend',   e=>{ const t=findTouch(e,stickTouch); if(t){ stickTouch=null; P.vx=P.vy=0; moveKnob(center.x,center.y);} }, {passive:false});
UI.stick.addEventListener('mousedown', e=>{ center=centerOf(UI.stick); const move=ev=>{ const dx=ev.clientX-center.x, dy=ev.clientY-center.y; const maxR=48, d=Math.hypot(dx,dy)||1; const nx=center.x+(d>maxR?dx/d*maxR:dx); const ny=center.y+(d>maxR?dy/d*maxR:dy); moveKnob(nx,ny); P.vx=(nx-center.x)/maxR; P.vy=(ny-center.y)/maxR; }; const up=()=>{ P.vx=P.vy=0; moveKnob(center.x,center.y); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); }; window.addEventListener('mousemove',move); window.addEventListener('mouseup',up); });
window.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft'||e.key==='a')keyDir.x=-1; if(e.key==='ArrowRight'||e.key==='d')keyDir.x=1; if(e.key==='ArrowUp'||e.key==='w')keyDir.y=-1; if(e.key==='ArrowDown'||e.key==='s')keyDir.y=1; });
window.addEventListener('keyup',   e=>{ if(['ArrowLeft','a','ArrowRight','d'].includes(e.key))keyDir.x=0; if(['ArrowUp','w','ArrowDown','s'].includes(e.key))keyDir.y=0; });
function applyJoystick(dt){ if(keyDir.x||keyDir.y){ P.vx=keyDir.x; P.vy=keyDir.y; } const m=Math.hypot(P.vx,P.vy); if(m>1e-3){ P.vx/=Math.max(1,m); P.vy/=Math.max(1,m);} if(!stickTouch && !keyDir.x && !keyDir.y){ const decay=Math.exp(-6*dt); P.vx*=decay; P.vy*=decay; if(Math.abs(P.vx)<0.01)P.vx=0; if(Math.abs(P.vy)<0.01)P.vy=0; } }
function centerOf(el){ const r=el.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height/2}; }
function moveKnob(x,y){ if(!center) center=centerOf(UI.stick); UI.knob.style.transform=`translate(${x-center.x}px, ${y-center.y}px)`; }
function findTouch(e,id){ for(const t of e.changedTouches) if(t.identifier===id) return t; return null; }

/* ===== Items & Effects ===== */
function spawnItem(){ const types=['MARLB','CUP','SHEE','TANK']; const weights=[0.5,0.25,0.18,0.07]; const type=pickWeighted(types,weights); const id=FB.enabled?FB.db.ref().push().key:'loc-'+Math.random().toString(36).slice(2); const it={id,type,x:rand(0,WORLD.w),y:rand(0,WORLD.h),claimedBy:null}; ITEMS.set(it.id,it); if(FB.enabled){ FB.db.ref(`lationcup/rooms/default/items/${it.id}`).set(it).catch(()=>{});} }
function pickWeighted(arr,w){ const s=w.reduce((a,b)=>a+b,0); let r=Math.random()*s; for(let i=0;i<arr.length;i++){ r-=w[i]; if(r<=0) return arr[i]; } return arr[0]; }

function claimItem(it){
  if (!FB.enabled){ localResolve(it); return; }
  const ref=FB.db.ref(`lationcup/rooms/default/items/${it.id}`);
  ref.transaction(cur=>{
    if(!cur||cur.claimedBy) return cur||it;
    cur.claimedBy=FB.uid; return cur;
  }, (err,committed,snap)=>{
    if(err||!committed) return;
    ITEMS.set(it.id,snap.val());
    localResolve(snap.val(),true);
  });
}

function flash(color){
  // simple rim flash on canvas
  CV.style.boxShadow = `0 0 0 5px ${color}66 inset`;
  setTimeout(()=> CV.style.boxShadow='',150);
}

/* ===== Mini‑game (6s, with momentum) ===== */
const Mini = {active:false, taps:0, time:6, progress:0, puffs:0, toggle:false};
function startMiniGame(){
  Mini.active=true; Mini.taps=0; Mini.time=6; Mini.progress=0; Mini.puffs=0; Mini.toggle=false;
  UI.mini.style.display='flex'; UI.bar.style.width='0%'; UI.puffCounter.textContent='Puffs: 0'; UI.miniClock.textContent='6s';
  setSprite(false);

  const decayPerSec = 0.18;
  const gainPerTap  = 0.09;
  let lastTs = performance.now();

  const onTap = (ev)=>{ ev&&ev.preventDefault(); if(!Mini.active)return;
    Mini.taps++; Mini.toggle=!Mini.toggle; setSprite(Mini.toggle);
    Mini.progress = Math.min(1, Mini.progress + gainPerTap);
    if (Mini.progress >= 1){
      Mini.puffs++;
      UI.puffCounter.textContent = `Puffs: ${Mini.puffs}`;
      Mini.progress = 0.6; // keep momentum
    }
    UI.bar.style.width = (Mini.progress*100)+'%';
  };
  UI.tapBtn.onpointerdown = onTap;

  return new Promise(resolve=>{
    const secIv = setInterval(()=>{
      Mini.time -= 1; UI.miniClock.textContent = `${Math.max(0,Math.ceil(Mini.time))}s`;
      if (Mini.time<=0){ clearInterval(secIv); cancelAnimationFrame(anim); finish(); }
    },1000);

    function tick(){
      if (!Mini.active) return;
      const now = performance.now();
      const dt = Math.min(0.05, (now - lastTs)/1000); lastTs = now;
      Mini.progress = Math.max(0, Mini.progress - decayPerSec*dt);
      UI.bar.style.width = (Mini.progress*100)+'%';
      anim = requestAnimationFrame(tick);
    }
    let anim = requestAnimationFrame(tick);

    function finish(){
      Mini.active=false; UI.mini.style.display='none';
      G.score += Math.round(Mini.puffs * G.mult);
      resolve(Mini.puffs);
    }
  });
}
function setSprite(useSecond){
  if (SMOKE.hasImgs){
    const img = useSecond ? SMOKE.img2 : SMOKE.img1;
    UI.smokeSprite.textContent=''; UI.smokeSprite.style.backgroundImage=''; UI.smokeSprite.innerHTML='';
    const el = new Image(); el.src = img.src; el.style.width='100%'; el.style.height='100%'; el.style.objectFit='cover';
    UI.smokeSprite.appendChild(el);
  } else {
    UI.smokeSprite.style.backgroundImage=''; UI.smokeSprite.textContent = useSecond ? '😮‍💨' : '🚬';
  }
}

/* ===== Resolve items ===== */
function localResolve(it){
  if (it.type==='CUP'){ G.mult = Math.min(3, G.mult+0.4); flash('#2e7d32'); }
  else if (it.type==='TANK'){ G.mult = Math.min(4, G.mult+1.0); flash('#18ff9b'); }
  else if (it.type==='SHEE'){ G.mult = Math.max(0.5, G.mult-0.6); flash('#aaaaaa'); }
  else if (it.type==='MARLB'){ startMiniGame().then(()=>{}); }
  ITEMS.delete(it.id);
  if (FB.enabled){ FB.db.ref(`lationcup/rooms/default/items/${it.id}`).remove().catch(()=>{}); }
}

/* ===== Multiplayer plumbing ===== */
function subPlayers(){ if(!FB.enabled)return;
  FB.db.ref('lationcup/rooms/default/players').on('value', snap=>{
    const v=snap.val()||{}; OTHERS.clear();
    for (const k in v) if (k!==FB.uid) OTHERS.set(k,v[k]);
    const arr=Object.values(v).sort((a,b)=>(b.score||0)-(a.score||0)||(b.ts||0)-(a.ts||0));
    UI.lb.innerHTML = arr.map((p,i)=> `<div>${i+1}. <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${p.color||'#fff'}"></span> ${escapeHtml(p.name||'Anon')} — 🟥 ${p.score||0}</div>`).join('') || '(waiting for players...)';
  });
}
function subItems(){ if(!FB.enabled)return;
  FB.db.ref('lationcup/rooms/default/items').on('value', snap=>{
    const v=snap.val()||{}; ITEMS.clear(); for(const id in v) ITEMS.set(id,v[id]);
  });
}
function pushPlayer(){ if(!FB.enabled||!FB.uid)return; if(G.state!=='play'&&G.state!=='over')return;
  FB.db.ref(`lationcup/rooms/default/players/${FB.uid}`).update({name:UI.name.value.trim(), x:Math.round(P.x), y:Math.round(P.y), score:G.score, ts:Date.now(), color:P.color}).catch(()=>{});
}

/* ===== Utils & reset ===== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function resetGame(){
  G.time=180; G.score=0; G.mult=1; G.state='play';
  P.x=WORLD.w/2; P.y=WORLD.h/2; P.vx=P.vy=0;
  ITEMS.clear(); for (let i=0;i<25;i++) spawnItem();
  if (FB.enabled){
    FB.db.ref('lationcup/rooms/default/items').once('value').then(s=>{
      if (!s.exists()){
        const batch={}; for (const it of ITEMS.values()) batch[it.id]=it;
        FB.db.ref('lationcup/rooms/default/items').set(batch).catch(()=>{});
      }
    });
  }
}
function logErr(msg){ const box=document.getElementById('err'); box.style.display='block'; box.textContent=String(msg); }
</script>
</body>
</html>